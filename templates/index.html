<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NARFU</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="sidebar">
        <img src="logo.png" alt="Logo">
        <button onclick="showContent('inicio')">Inicio</button>
        <button onclick="showContent('algo')">Algo nose</button>
        <button onclick="showContent('graficos')">Graficos y Datos</button>
        <button onclick="showContent('inicio')">Algo sise</button>
    </div>
    <div class="main-content">
        <div class="header">
            <h1>Plantación de [USUARIO]</h1>
            <p>19/07/2024</p>
        </div>
        <div class="content">
            <!-- PESTAÑA HOME -->
            <div id="inicio">
                <div style="font-size: large;">NECESIDAD DE RIEGO:
                    <div style="font-size: xx-large;" class="box" style="background-color: #f7f1d4;">
                        yo caxo que si 
                    </div>
                </div>
                <div class="grid">
                    <div style="font-size: large; margin-left: 40%; width: 300px;">ÚLTIMA MEDICIÓN:
                        <div id="data-container" class="box" style="background-color: #d4f7d4;"></div>
                    </div>
                    <div style="font-size: large; margin-left: 30%;">CLIMA:
                        <div id="climate-container" class="box" style="background-color: #f7d4d4;"></div>
                    </div>
                </div>
            </div>
            <!-- PESTAÑA INGRESO DE DATOS -->
            <div id="graficos" class="hidden">
                <div class="form-container">
                    <form id="fetch-form">
                        <label for="sensor-id">Ingrese ID del sensor:</label>
                        <input type="number" id="sensor-id" name="sensor-id" required>
                        <button type="submit">Obtener datos</button>
                    </form>
                </div>                
            </div>
            <!-- PESTAÑAS -->
            <div id="algo" class="hidden">
                <div class="calendar">
                    <h2>Calendario</h2>
                    <div class="month">
                        <div class="month-box"></div>
                        <div class="month-box"></div>
                        <div class="month-box"></div>
                    </div>
                    <div class="month">
                        <div class="month-box"></div>
                        <div class="month-box"></div>
                        <div class="month-box"></div>
                    </div>
                </div>
            </div>
            <!-- PESTAÑAS -->
            <div id="algo" class="hidden">
                <div class="calendar">
                    <h2>Calendario</h2>
                    <div class="month">
                        <div class="month-box"></div>
                        <div class="month-box"></div>
                        <div class="month-box"></div>
                    </div>
                    <div class="month">
                        <div class="month-box"></div>
                        <div class="month-box"></div>
                        <div class="month-box"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showContent(section) {
            document.querySelectorAll('.content > div').forEach(div => {
                div.classList.add('hidden');
            });
            document.getElementById(section).classList.remove('hidden');
        }

        document.querySelectorAll('.content > div').forEach(div => {
            if (div.id !== 'inicio') {
                div.classList.add('hidden');
            }
        });

        async function updateAndFetchData() {
            try {
                await fetch('/update-data'); // Actualiza data.json
                const response = await fetch('/data.json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                const container = document.getElementById('data-container');
                container.innerHTML = ''; // Clear previous data

                if (data.length > 0) {
                    const item = data[0];
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('data-item');

                    const temperatureDiv = document.createElement('div');
                    temperatureDiv.classList.add('data-title');
                    temperatureDiv.textContent = `Temperatura: ${item.temperatura}°C`;
                    itemDiv.appendChild(temperatureDiv);

                    const humidityDiv = document.createElement('div');
                    humidityDiv.classList.add('data-title');
                    humidityDiv.textContent = `Humedad: ${item.humedad}%`;
                    itemDiv.appendChild(humidityDiv);

                    const soilHumidityDiv = document.createElement('div');
                    soilHumidityDiv.classList.add('data-title');
                    soilHumidityDiv.textContent = `Humedad del Suelo: ${item.humedad_suelo}%`;
                    itemDiv.appendChild(soilHumidityDiv);

                    if (item.timestamp) {
                        const timestampDiv = document.createElement('div');
                        timestampDiv.classList.add('data-title');
                        timestampDiv.textContent = `Hora registrada: ${item.timestamp}`;
                        itemDiv.appendChild(timestampDiv);
                    }

                    container.appendChild(itemDiv);
                } else {
                    container.textContent = 'No data available';
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function fetchWeatherData() {
            try {
                const response = await fetch('https://api.openweathermap.org/data/2.5/weather?q=Ovalle&appid=1ef0ca182efbf978e8ae8d643846e536&units=metric&lang=es');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const weatherData = await response.json();
                const climateContainer = document.getElementById('climate-container');
                climateContainer.innerHTML = ''; // Clear previous data

                const cityDiv = document.createElement('div');
                cityDiv.textContent = `Ciudad: ${weatherData.name}`;
                climateContainer.appendChild(cityDiv);

                const tempDiv = document.createElement('div');
                tempDiv.textContent = `Temperatura: ${weatherData.main.temp}°C`;
                climateContainer.appendChild(tempDiv);

                const windDiv = document.createElement('div');
                windDiv.textContent = `Velocidad del viento: ${weatherData.wind.speed} m/s`;
                climateContainer.appendChild(windDiv);

                const descriptionDiv = document.createElement('div');
                descriptionDiv.textContent = `Descripción: ${weatherData.weather[0].description}`;
                climateContainer.appendChild(descriptionDiv);

            } catch (error) {
                console.error('Error fetching weather data:', error);
            }
        }

        // Call the function to update and fetch data when the page loads
        updateAndFetchData();
        fetchWeatherData();

        // Update data every 5 seconds
        setInterval(updateAndFetchData, 5000);
        setInterval(fetchWeatherData, 60000); // Fetch weather data every 60 seconds
    </script>
</body>
</html>
